/* Starts of runs of zero width characters. */
static uint16_t zerowidth_low[] = {
	0x300, 0x483, 0x591, 0x5bf, 0x5c1, 0x5c4, 0x5c7, 0x600, 0x610, 0x61c,
    0x64b, 0x670, 0x6d6, 0x6df, 0x6e7, 0x6ea, 0x70f, 0x711, 0x730, 0x7a6, 0x7eb,
    0x7fd, 0x816, 0x81b, 0x825, 0x829, 0x859, 0x890, 0x8ca, 0x93a, 0x93c, 0x941,
    0x94d, 0x951, 0x962, 0x981, 0x9bc, 0x9c1, 0x9cd, 0x9e2, 0x9fe, 0xa3c, 0xa41,
    0xa70, 0xa75, 0xa81, 0xabc, 0xac1, 0xacd, 0xae2, 0xafa, 0xb3c, 0xb3f, 0xb41,
    0xb4d, 0xb62, 0xb82, 0xbc0, 0xbcd, 0xc00, 0xc04, 0xc3c, 0xc3e, 0xc46, 0xc62,
    0xc81, 0xcbc, 0xcbf, 0xcc6, 0xccc, 0xce2, 0xd00, 0xd3b, 0xd41, 0xd4d, 0xd62,
    0xd81, 0xdca, 0xdd2, 0xe31, 0xe34, 0xe47, 0xeb1, 0xeb4, 0xec8, 0xf18, 0xf35,
    0xf37, 0xf39, 0xf71, 0xf80, 0xf86, 0xf8d, 0xfc6, 0x102d, 0x1032, 0x1039,
    0x103d, 0x1058, 0x105e, 0x1071, 0x1082, 0x1085, 0x108d, 0x109d, 0x135d,
    0x1712, 0x1732, 0x1752, 0x1772, 0x17b4, 0x17b7, 0x17c6, 0x17c9, 0x17dd,
    0x180b, 0x1885, 0x18a9, 0x1920, 0x1927, 0x1932, 0x1939, 0x1a17, 0x1a1b,
    0x1a56, 0x1a58, 0x1a62, 0x1a65, 0x1a73, 0x1ab0, 0x1b34, 0x1b36, 0x1b3c,
    0x1b42, 0x1b6b, 0x1b80, 0x1ba2, 0x1ba8, 0x1bab, 0x1be6, 0x1be8, 0x1bed,
    0x1bef, 0x1c2c, 0x1c36, 0x1cd0, 0x1cd4, 0x1ce2, 0x1ced, 0x1cf4, 0x1cf8,
    0x1dc0, 0x200b, 0x202a, 0x2060, 0x20d0, 0x2cef, 0x2d7f, 0x2de0, 0x302a,
    0x3099, 0xa66f, 0xa674, 0xa69e, 0xa6f0, 0xa802, 0xa806, 0xa80b, 0xa825,
    0xa82c, 0xa8c4, 0xa8e0, 0xa8ff, 0xa926, 0xa947, 0xa980, 0xa9b3, 0xa9b6,
    0xa9bc, 0xa9e5, 0xaa29, 0xaa31, 0xaa35, 0xaa43, 0xaa4c, 0xaa7c, 0xaab0,
    0xaab2, 0xaab7, 0xaabe, 0xaac1, 0xaaec, 0xaaf6, 0xabe5, 0xabe8, 0xabed,
    0xfb1e, 0xfe00, 0xfe20, 0xfeff, 0xfff9,
};

static uint16_t zerowidth_high[] = {
	0x1fd, 0x2e0, 0x376, 0xa01, 0xa38, 0xae5, 0xd24, 0xeab, 0xefd, 0xf46,
    0xf82, 0x1001, 0x1038, 0x1070, 0x1073, 0x107f, 0x10b3, 0x10b9, 0x10bd,
    0x10c2, 0x1100, 0x1127, 0x112d, 0x1173, 0x1180, 0x11b6, 0x11c9, 0x11cf,
    0x122f, 0x1234, 0x1236, 0x123e, 0x1241, 0x12df, 0x12e3, 0x1300, 0x133b,
    0x1340, 0x1366, 0x1438, 0x1442, 0x1446, 0x145e, 0x14b3, 0x14ba, 0x14bf,
    0x14c2, 0x15b2, 0x15bc, 0x15bf, 0x15dc, 0x1633, 0x163d, 0x163f, 0x16ab,
    0x16ad, 0x16b0, 0x16b7, 0x171d, 0x1722, 0x1727, 0x182f, 0x1839, 0x193b,
    0x193e, 0x1943, 0x19d4, 0x19e0, 0x1a01, 0x1a33, 0x1a3b, 0x1a47, 0x1a51,
    0x1a59, 0x1a8a, 0x1a98, 0x1c30, 0x1c3f, 0x1c92, 0x1caa, 0x1cb2, 0x1cb5,
    0x1d31, 0x1d47, 0x1d90, 0x1d95, 0x1d97, 0x1ef3, 0x1f00, 0x1f36, 0x1f40,
    0x1f42, 0x3430, 0x3447, 0x6af0, 0x6b30, 0x6f4f, 0x6f8f, 0x6fe4, 0xbc9d,
    0xbca0, 0xd167, 0xd173, 0xd185, 0xd1aa, 0xd242, 0xda00, 0xda3b, 0xda75,
    0xda84, 0xda9b, 0xe000, 0xe08f, 0xe130, 0xe2ae, 0xe2ec, 0xe4ec, 0xe8d0,
    0xe944,
};

/* Starts of runs of normal characters. */
static uint16_t normal_low[] = {
	1, 0x370, 0x48a, 0x5be, 0x5c0, 0x5c3, 0x5c6, 0x5d0, 0x606, 0x61b, 0x61d,
    0x660, 0x671, 0x6de, 0x6e5, 0x6e9, 0x6ee, 0x710, 0x712, 0x74d, 0x7b1, 0x7f4,
    0x7fe, 0x81a, 0x824, 0x828, 0x830, 0x85e, 0x8a0, 0x903, 0x93b, 0x93d, 0x949,
    0x94e, 0x958, 0x964, 0x982, 0x9bd, 0x9c7, 0x9ce, 0x9e6, 0xa03, 0xa3e, 0xa59,
    0xa72, 0xa76, 0xa83, 0xabd, 0xac9, 0xad0, 0xae6, 0xb02, 0xb3d, 0xb40, 0xb47,
    0xb57, 0xb66, 0xb83, 0xbc1, 0xbd0, 0xc01, 0xc05, 0xc3d, 0xc41, 0xc58, 0xc66,
    0xc82, 0xcbd, 0xcc0, 0xcc7, 0xcd5, 0xce6, 0xd02, 0xd3d, 0xd46, 0xd4e, 0xd66,
    0xd82, 0xdcf, 0xdd8, 0xe32, 0xe3f, 0xe4f, 0xeb2, 0xebd, 0xed0, 0xf1a, 0xf36,
    0xf38, 0xf3a, 0xf7f, 0xf85, 0xf88, 0xfbe, 0xfc7, 0x1031, 0x1038, 0x103b,
    0x103f, 0x105a, 0x1061, 0x1075, 0x1083, 0x1087, 0x108e, 0x109e, 0x1160,
    0x1360, 0x1715, 0x1734, 0x1760, 0x1780, 0x17b6, 0x17be, 0x17c7, 0x17d4,
    0x17e0, 0x1810, 0x1887, 0x18aa, 0x1923, 0x1929, 0x1933, 0x1940, 0x1a19,
    0x1a1e, 0x1a57, 0x1a61, 0x1a63, 0x1a6d, 0x1a80, 0x1b04, 0x1b35, 0x1b3b,
    0x1b3d, 0x1b43, 0x1b74, 0x1b82, 0x1ba6, 0x1baa, 0x1bae, 0x1be7, 0x1bea,
    0x1bee, 0x1bf2, 0x1c34, 0x1c3b, 0x1cd3, 0x1ce1, 0x1ce9, 0x1cee, 0x1cf5,
    0x1cfa, 0x1e00, 0x2010, 0x202f, 0x2070, 0x2100, 0x231c, 0x232b, 0x23ed,
    0x23f1, 0x23f4, 0x25ff, 0x2616, 0x2654, 0x2680, 0x2694, 0x26a2, 0x26ac,
    0x26bf, 0x26c6, 0x26cf, 0x26d5, 0x26eb, 0x26f4, 0x26f6, 0x26fb, 0x26fe,
    0x2706, 0x270c, 0x2729, 0x274d, 0x274f, 0x2756, 0x2758, 0x2798, 0x27b1,
    0x27c0, 0x2b1d, 0x2b51, 0x2b56, 0x2cf2, 0x2d80, 0x2e00, 0x303f, 0x3248,
    0x4dc0, 0xa4d0, 0xa673, 0xa67e, 0xa6a0, 0xa6f2, 0xa803, 0xa807, 0xa80c,
    0xa827, 0xa830, 0xa8ce, 0xa8f2, 0xa900, 0xa92e, 0xa952, 0xa983, 0xa9b4,
    0xa9ba, 0xa9be, 0xa9e6, 0xaa2f, 0xaa33, 0xaa40, 0xaa44, 0xaa4d, 0xaa7d,
    0xaab1, 0xaab5, 0xaab9, 0xaac0, 0xaac2, 0xaaee, 0xab01, 0xabe6, 0xabe9,
    0xabf0, 0xd7b0, 0xfb00, 0xfb1f, 0xfe70, 0xff61, 0xffe8, 0xfffc,
};

static uint16_t normal_high[] = {
	1, 0x280, 0x2e1, 0x380, 0xa10, 0xa40, 0xaeb, 0xd30, 0xead, 0xf00, 0xf51,
    0xf86, 0x1002, 0x1047, 0x1071, 0x1075, 0x1082, 0x10b7, 0x10bb, 0x10be,
    0x10d0, 0x1103, 0x112c, 0x1136, 0x1174, 0x1182, 0x11bf, 0x11cd, 0x11d0,
    0x1232, 0x1235, 0x1238, 0x123f, 0x1280, 0x12e0, 0x12f0, 0x1302, 0x133d,
    0x1341, 0x1400, 0x1440, 0x1445, 0x1447, 0x145f, 0x14b9, 0x14bb, 0x14c1,
    0x14c4, 0x15b8, 0x15be, 0x15c1, 0x1600, 0x163b, 0x163e, 0x1641, 0x16ac,
    0x16ae, 0x16b6, 0x16b8, 0x1720, 0x1726, 0x1730, 0x1838, 0x183b, 0x193d,
    0x193f, 0x1944, 0x19dc, 0x19e1, 0x1a0b, 0x1a39, 0x1a3f, 0x1a50, 0x1a57,
    0x1a5c, 0x1a97, 0x1a9a, 0x1c3e, 0x1c40, 0x1ca9, 0x1cb1, 0x1cb4, 0x1d00,
    0x1d46, 0x1d50, 0x1d93, 0x1d96, 0x1d98, 0x1ef5, 0x1f02, 0x1f3e, 0x1f41,
    0x1f43, 0x3441, 0x4400, 0x6af5, 0x6b37, 0x6f50, 0x6f93, 0xbc00, 0xbc9f,
    0xcf50, 0xd16a, 0xd183, 0xd18c, 0xd1ae, 0xd245, 0xda37, 0xda6d, 0xda76,
    0xda85, 0xdf00, 0xe030, 0xe100, 0xe137, 0xe2c0, 0xe2f0, 0xe4f0, 0xe900,
    0xe94b, 0xf005, 0xf0d1, 0xf18f, 0xf19b, 0xf321, 0xf336, 0xf37d, 0xf394,
    0xf3cb, 0xf3d4, 0xf3f1, 0xf3f5, 0xf43f, 0xf441, 0xf4fd, 0xf53e, 0xf54f,
    0xf568, 0xf57b, 0xf597, 0xf5a5, 0xf650, 0xf6c6, 0xf6cd, 0xf6d3, 0xf6e0,
    0xf6f0, 0xf700, 0xf800, 0xf93b, 0xf946, 0xfa00, 0xfb00,
};

/* Starts of runs of character with "Wide" or "Fullwidth" East Asian Width property. */
static uint16_t wide_low[] = {
	0x1100, 0x231a, 0x2329, 0x23e9, 0x23f0, 0x23f3, 0x25fd, 0x2614, 0x2648,
    0x267f, 0x2693, 0x26a1, 0x26aa, 0x26bd, 0x26c4, 0x26ce, 0x26d4, 0x26ea,
    0x26f2, 0x26f5, 0x26fa, 0x26fd, 0x2705, 0x270a, 0x2728, 0x274c, 0x274e,
    0x2753, 0x2757, 0x2795, 0x27b0, 0x27bf, 0x2b1b, 0x2b50, 0x2b55, 0x2e80,
    0x302e, 0x3041, 0x309b, 0x3250, 0x4e00, 0xa960, 0xac00, 0xf900, 0xfe10,
    0xfe30, 0xff01, 0xffe0,
};

static uint16_t wide_high[] = {
	0x6fe0, 0x6ff0, 0xf004, 0xf0cf, 0xf18e, 0xf191, 0xf200, 0xf32d, 0xf337,
    0xf37e, 0xf3a0, 0xf3cf, 0xf3e0, 0xf3f4, 0xf3f8, 0xf440, 0xf442, 0xf4ff,
    0xf54b, 0xf550, 0xf57a, 0xf595, 0xf5a4, 0xf5fb, 0xf680, 0xf6cc, 0xf6d0,
    0xf6d5, 0xf6eb, 0xf6f4, 0xf7e0, 0xf90c, 0xf93c, 0xf947, 0xfa70,
};

uint16_t find_code(uint16_t code, uint16_t array[], size_t array_len)
{
	// TODO: binary search

	uint16_t last = 0;

	for (size_t i = 0; i < array_len; i++) {
		if (array[i] > code)
			return last;

		last = array[i];
	}

	return last;
}

#define find_code(c, array) find_code(c, array, sizeof(array) / sizeof(array[0]))

int unicode_character_width(char32_t c) {
	if (c <= 0x300)
		return c != 0xad;

	if (c >= 0x20000)
		return 2;

	uint16_t zerowidth_start;
	uint16_t normal_start;
	uint16_t wide_start;

	if (c < 0x10000) {
		zerowidth_start = find_code(c, zerowidth_low);
		normal_start = find_code(c, normal_low);
		wide_start = find_code(c, wide_low);

	} else {
		c = c - 0x10000;

		zerowidth_start = find_code(c, zerowidth_high);
		normal_start = find_code(c, normal_high);
		wide_start = find_code(c, wide_high);
	}

	if (zerowidth_start > normal_start && zerowidth_start > wide_start)
		return 0;

	if (normal_start > wide_start)
		return 1;

	return 2;
}

int unicode_string_width(const char *s, size_t max_bytes) {
	int n = 0;
	mbstate_t mb;
	mbstate_init(&mb);

	char32_t c;
	size_t r;
	while ((r = mbrtoc32(&c, s, max_bytes, &mb)) <= MB_MAX_LEN) {
		s += r;
		max_bytes -= r;

		n += unicode_character_width(c);
	}

	return n;
}
